name: PR-ism All-in-One (Reusable)

on:
  workflow_call:
    inputs:
      stats_webhook_url:
        description: "Stats server base URL"
        required: true
        type: string
        default: "https://stats.pr-ism.site"
      slack_webhook_url:
        description: "Slack server base URL"
        required: true
        type: string
        default: "https://slack.pr-ism.site"
    secrets:
      PRISM_API_KEY:
        required: true

permissions:
  contents: read
  pull-requests: read

env:
  PRISM_API_KEY: ${{ secrets.PRISM_API_KEY }}

defaults:
  run:
    shell: bash

jobs:
  # ──────────────────────────────────────────────
  # 1. PR Opened
  # ──────────────────────────────────────────────
  # Endpoint: POST /collect/pull-request/opened
  # Request DTO: PullRequestOpenedRequest
  #   - isDraft: boolean
  #   - pullRequest: { githubPullRequestId, number, title, url, headCommitSha,
  #                     additions, deletions, changedFiles, createdAt,
  #                     author: { login, id }, commits: { totalCount, nodes[] } }
  #   - files: [{ filename, status, additions, deletions }]
  # ──────────────────────────────────────────────
  collect-pr-opened:
    if: github.event.action == 'opened'
    runs-on: ubuntu-latest
    env:
      WEBHOOK_URL: ${{ inputs.stats_webhook_url }}
    steps:
      - name: Setup PR-ism helpers
        uses: pr-ism/github-actions/.github/actions/prism-helpers@v1

      - name: Handle opened event
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_DATA=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $number) {
                  number
                  title
                  url
                  additions
                  deletions
                  changedFiles
                  createdAt
                  author { login }
                  commits(first: 100) {
                    totalCount
                    nodes {
                      commit {
                        oid
                        committedDate
                      }
                    }
                  }
                }
              }
            }
          ' -f owner='${{ github.repository_owner }}' \
            -f repo='${{ github.event.repository.name }}' \
            -F number=${{ github.event.pull_request.number }})

          FILES_DATA=$(gh api \
            "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            --jq '[.[] | {filename, status, additions, deletions}]')

          PAYLOAD=$(jq -n \
            --argjson prData "$PR_DATA" \
            --argjson files "$FILES_DATA" \
            --argjson isDraft '${{ toJson(github.event.pull_request.draft) }}' \
            --argjson githubPullRequestId "${{ github.event.pull_request.id }}" \
            --arg headCommitSha "${{ github.event.pull_request.head.sha }}" \
            --argjson authorId "${{ github.event.pull_request.user.id }}" \
            '{
              isDraft: $isDraft,
              pullRequest: ($prData.data.repository.pullRequest + {
                githubPullRequestId: $githubPullRequestId,
                headCommitSha: $headCommitSha
              } | .author += {id: $authorId}),
              files: $files
            }')

          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PRISM_API_KEY" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL/collect/pull-request/opened"

  # ──────────────────────────────────────────────
  # 2. PR Closed (closed / merged)
  # ──────────────────────────────────────────────
  # Endpoint: POST /collect/pull-request/closed
  # Request DTO: PullRequestClosedRequest
  #   - pullRequestNumber, isMerged, closedAt, mergedAt
  # ──────────────────────────────────────────────
  collect-pr-closed:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    env:
      WEBHOOK_URL: ${{ inputs.stats_webhook_url }}
    steps:
      - name: Setup PR-ism helpers
        uses: pr-ism/github-actions/.github/actions/prism-helpers@v1

      - name: Handle closed event
        env:
          MERGED_AT: ${{ github.event.pull_request.merged_at }}
        run: |
          PAYLOAD=$(jq -n \
            --argjson pullRequestNumber "${{ github.event.pull_request.number }}" \
            --argjson isMerged '${{ toJson(github.event.pull_request.merged) }}' \
            --arg closedAt "${{ github.event.pull_request.closed_at }}" \
            --arg mergedAt "$MERGED_AT" \
            '{
              pullRequestNumber: $pullRequestNumber,
              isMerged: $isMerged,
              closedAt: $closedAt,
              mergedAt: (if $mergedAt == "" then null else $mergedAt end)
            }')

          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PRISM_API_KEY" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL/collect/pull-request/closed"

  # ──────────────────────────────────────────────
  # 3. PR Synchronized
  # ──────────────────────────────────────────────
  # Endpoint: POST /collect/pull-request/synchronized
  # Request DTO: PullRequestSynchronizedRequest
  #   - pullRequestNumber, headCommitSha, additions, deletions, changedFiles,
  #     commits: { totalCount, nodes: [{ sha, committedDate }] },
  #     files: [{ filename, status, additions, deletions }]
  # ──────────────────────────────────────────────
  collect-pr-synchronized:
    if: github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    env:
      WEBHOOK_URL: ${{ inputs.stats_webhook_url }}
    steps:
      - name: Setup PR-ism helpers
        uses: pr-ism/github-actions/.github/actions/prism-helpers@v1

      - name: Handle synchronized event
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_DATA=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $number) {
                  additions
                  deletions
                  changedFiles
                  commits(first: 100) {
                    totalCount
                    nodes {
                      commit {
                        oid
                        committedDate
                      }
                    }
                  }
                }
              }
            }
          ' -f owner='${{ github.repository_owner }}' \
            -f repo='${{ github.event.repository.name }}' \
            -F number=${{ github.event.pull_request.number }})

          FILES_DATA=$(gh api \
            "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            --jq '[.[] | {filename, status, additions, deletions}]')

          PR=$(echo "$PR_DATA" | jq '.data.repository.pullRequest')

          COMMITS=$(echo "$PR" | jq '{
            totalCount: .commits.totalCount,
            nodes: [.commits.nodes[] | {sha: .commit.oid, committedDate: .commit.committedDate}]
          }')

          PAYLOAD=$(jq -n \
            --argjson pullRequestNumber "${{ github.event.pull_request.number }}" \
            --arg headCommitSha "${{ github.event.pull_request.head.sha }}" \
            --argjson additions "$(echo "$PR" | jq '.additions')" \
            --argjson deletions "$(echo "$PR" | jq '.deletions')" \
            --argjson changedFiles "$(echo "$PR" | jq '.changedFiles')" \
            --argjson commits "$COMMITS" \
            --argjson files "$FILES_DATA" \
            '{
              pullRequestNumber: $pullRequestNumber,
              headCommitSha: $headCommitSha,
              additions: $additions,
              deletions: $deletions,
              changedFiles: $changedFiles,
              commits: $commits,
              files: $files
            }')

          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PRISM_API_KEY" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL/collect/pull-request/synchronized"

  # ──────────────────────────────────────────────
  # 4. PR Label (labeled / unlabeled)
  # ──────────────────────────────────────────────
  # Endpoint: POST /collect/pull-request/label/added
  # Request DTO: PullRequestLabelAddedRequest
  #   - githubPullRequestId, pullRequestNumber, headCommitSha,
  #     label: { name }, labeledAt
  #
  # Endpoint: POST /collect/pull-request/label/removed
  # Request DTO: PullRequestLabelRemovedRequest
  #   - githubPullRequestId, pullRequestNumber, headCommitSha,
  #     label: { name }, unlabeledAt
  # ──────────────────────────────────────────────
  collect-pr-label:
    if: github.event.action == 'labeled' || github.event.action == 'unlabeled'
    runs-on: ubuntu-latest
    env:
      WEBHOOK_URL: ${{ inputs.stats_webhook_url }}
    steps:
      - name: Setup PR-ism helpers
        uses: pr-ism/github-actions/.github/actions/prism-helpers@v1

      - name: Handle labeled event
        if: github.event.action == 'labeled'
        run: |
          PAYLOAD=$(jq -n \
            --argjson githubPullRequestId "${{ github.event.pull_request.id }}" \
            --argjson pullRequestNumber "${{ github.event.pull_request.number }}" \
            --arg headCommitSha "${{ github.event.pull_request.head.sha }}" \
            --arg labelName "${{ github.event.label.name }}" \
            --arg labeledAt "$(utc_now)" \
            '{
              githubPullRequestId: $githubPullRequestId,
              pullRequestNumber: $pullRequestNumber,
              headCommitSha: $headCommitSha,
              label: { name: $labelName },
              labeledAt: $labeledAt
            }')

          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PRISM_API_KEY" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL/collect/pull-request/label/added"

      - name: Handle unlabeled event
        if: github.event.action == 'unlabeled'
        run: |
          PAYLOAD=$(jq -n \
            --argjson githubPullRequestId "${{ github.event.pull_request.id }}" \
            --argjson pullRequestNumber "${{ github.event.pull_request.number }}" \
            --arg headCommitSha "${{ github.event.pull_request.head.sha }}" \
            --arg labelName "${{ github.event.label.name }}" \
            --arg unlabeledAt "$(utc_now)" \
            '{
              githubPullRequestId: $githubPullRequestId,
              pullRequestNumber: $pullRequestNumber,
              headCommitSha: $headCommitSha,
              label: { name: $labelName },
              unlabeledAt: $unlabeledAt
            }')

          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PRISM_API_KEY" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL/collect/pull-request/label/removed"

  # ──────────────────────────────────────────────
  # 3. Reviewer (review_requested / review_request_removed)
  # ──────────────────────────────────────────────
  # Endpoint: POST /collect/review/reviewer/added
  # Request DTO: ReviewerAddedRequest
  #   - githubPullRequestId, pullRequestNumber, headCommitSha,
  #     reviewer: { login, id }, requestedAt
  #
  # Endpoint: POST /collect/review/reviewer/removed
  # Request DTO: ReviewerRemovedRequest
  #   - githubPullRequestId, pullRequestNumber, headCommitSha,
  #     reviewer: { login, id }, removedAt
  # ──────────────────────────────────────────────
  collect-reviewer:
    if: github.event.action == 'review_requested' || github.event.action == 'review_request_removed'
    runs-on: ubuntu-latest
    env:
      WEBHOOK_URL: ${{ inputs.stats_webhook_url }}
    steps:
      - name: Setup PR-ism helpers
        uses: pr-ism/github-actions/.github/actions/prism-helpers@v1

      - name: Handle review_requested event
        if: github.event.action == 'review_requested'
        env:
          REQUESTED_REVIEWER_LOGIN: ${{ github.event.requested_reviewer.login }}
          REQUESTED_REVIEWER_ID: ${{ github.event.requested_reviewer.id }}
          REQUESTED_TEAM_SLUG: ${{ github.event.requested_team.slug }}
          REQUESTED_TEAM_ID: ${{ github.event.requested_team.id }}
        run: |
          if [ -n "${REQUESTED_REVIEWER_ID:-}" ]; then
            LOGIN="$REQUESTED_REVIEWER_LOGIN"
            ID="$REQUESTED_REVIEWER_ID"
          else
            LOGIN="$REQUESTED_TEAM_SLUG"
            ID="$REQUESTED_TEAM_ID"
          fi

          PAYLOAD=$(jq -n \
            --argjson githubPullRequestId "${{ github.event.pull_request.id }}" \
            --argjson pullRequestNumber "${{ github.event.pull_request.number }}" \
            --arg headCommitSha "${{ github.event.pull_request.head.sha }}" \
            --arg login "$LOGIN" \
            --argjson id "${ID:-null}" \
            --arg requestedAt "$(utc_now)" \
            '{
              githubPullRequestId: $githubPullRequestId,
              pullRequestNumber: $pullRequestNumber,
              headCommitSha: $headCommitSha,
              reviewer: { login: $login, id: $id },
              requestedAt: $requestedAt
            }')

          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PRISM_API_KEY" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL/collect/review/reviewer/added"

      - name: Handle review_request_removed event
        if: github.event.action == 'review_request_removed'
        env:
          REQUESTED_REVIEWER_LOGIN: ${{ github.event.requested_reviewer.login }}
          REQUESTED_REVIEWER_ID: ${{ github.event.requested_reviewer.id }}
          REQUESTED_TEAM_SLUG: ${{ github.event.requested_team.slug }}
          REQUESTED_TEAM_ID: ${{ github.event.requested_team.id }}
        run: |
          if [ -n "${REQUESTED_REVIEWER_ID:-}" ]; then
            LOGIN="$REQUESTED_REVIEWER_LOGIN"
            ID="$REQUESTED_REVIEWER_ID"
          else
            LOGIN="$REQUESTED_TEAM_SLUG"
            ID="$REQUESTED_TEAM_ID"
          fi

          PAYLOAD=$(jq -n \
            --argjson githubPullRequestId "${{ github.event.pull_request.id }}" \
            --argjson pullRequestNumber "${{ github.event.pull_request.number }}" \
            --arg headCommitSha "${{ github.event.pull_request.head.sha }}" \
            --arg login "$LOGIN" \
            --argjson id "${ID:-null}" \
            --arg removedAt "$(utc_now)" \
            '{
              githubPullRequestId: $githubPullRequestId,
              pullRequestNumber: $pullRequestNumber,
              headCommitSha: $headCommitSha,
              reviewer: { login: $login, id: $id },
              removedAt: $removedAt
            }')

          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PRISM_API_KEY" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL/collect/review/reviewer/removed"

  # ──────────────────────────────────────────────
  # 4. Review Submitted
  # ──────────────────────────────────────────────
  # Endpoint: POST /collect/review/submitted
  # Request DTO: ReviewSubmittedRequest
  #   - githubPullRequestId, pullRequestNumber, githubReviewId,
  #     reviewer: { login, id }, state, commitSha, body,
  #     commentCount, submittedAt
  # ──────────────────────────────────────────────
  collect-review-submitted:
    if: github.event_name == 'pull_request_review' && github.event.action == 'submitted'
    runs-on: ubuntu-latest
    env:
      WEBHOOK_URL: ${{ inputs.stats_webhook_url }}
    steps:
      - name: Setup PR-ism helpers
        uses: pr-ism/github-actions/.github/actions/prism-helpers@v1

      - name: Handle review submitted event
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMENT_COUNT=$(gh api \
            "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews/${{ github.event.review.id }}/comments" \
            --jq 'length')

          PAYLOAD=$(jq -n \
            --argjson githubPullRequestId "${{ github.event.pull_request.id }}" \
            --argjson pullRequestNumber "${{ github.event.pull_request.number }}" \
            --argjson githubReviewId "${{ github.event.review.id }}" \
            --arg reviewerLogin "${{ github.event.review.user.login }}" \
            --argjson reviewerId "${{ github.event.review.user.id }}" \
            --arg state "${{ github.event.review.state }}" \
            --arg commitSha "${{ github.event.review.commit_id }}" \
            --arg body "${{ github.event.review.body }}" \
            --argjson commentCount "$COMMENT_COUNT" \
            --arg submittedAt "${{ github.event.review.submitted_at }}" \
            '{
              githubPullRequestId: $githubPullRequestId,
              pullRequestNumber: $pullRequestNumber,
              githubReviewId: $githubReviewId,
              reviewer: { login: $reviewerLogin, id: $reviewerId },
              state: $state,
              commitSha: $commitSha,
              body: $body,
              commentCount: $commentCount,
              submittedAt: $submittedAt
            }')

          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PRISM_API_KEY" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL/collect/review/submitted"

  # ──────────────────────────────────────────────
  # 5. Review Comment (created / edited / deleted)
  # ──────────────────────────────────────────────
  # Endpoint: POST /collect/review/comment/created
  # Request DTO: ReviewCommentCreatedRequest
  #   - githubCommentId, githubReviewId, body, path, line, startLine,
  #     side, commitSha, inReplyToId, author: { login, id },
  #     createdAt
  #
  # Endpoint: POST /collect/review/comment/edited
  # Request DTO: ReviewCommentEditedRequest
  #   - githubCommentId, body, updatedAt
  #
  # Endpoint: POST /collect/review/comment/deleted
  # Request DTO: ReviewCommentDeletedRequest
  #   - githubCommentId, updatedAt
  # ──────────────────────────────────────────────
  collect-review-comment:
    if: github.event_name == 'pull_request_review_comment'
    runs-on: ubuntu-latest
    env:
      WEBHOOK_URL: ${{ inputs.stats_webhook_url }}
    steps:
      - name: Setup PR-ism helpers
        uses: pr-ism/github-actions/.github/actions/prism-helpers@v1

      - name: Handle review comment created event
        if: github.event.action == 'created'
        run: |
          PAYLOAD=$(jq -n \
            --argjson githubCommentId "${{ github.event.comment.id }}" \
            --argjson githubReviewId "${{ github.event.comment.pull_request_review_id }}" \
            --arg body "${{ github.event.comment.body }}" \
            --arg path "${{ github.event.comment.path }}" \
            --argjson line "${{ github.event.comment.line || 0 }}" \
            --argjson startLine "${{ github.event.comment.start_line || 'null' }}" \
            --arg side "${{ github.event.comment.side }}" \
            --arg commitSha "${{ github.event.comment.commit_id }}" \
            --argjson inReplyToId "${{ github.event.comment.in_reply_to_id || 'null' }}" \
            --arg authorLogin "${{ github.event.comment.user.login }}" \
            --argjson authorId "${{ github.event.comment.user.id }}" \
            --arg createdAt "${{ github.event.comment.created_at }}" \
            '{
              githubCommentId: $githubCommentId,
              githubReviewId: $githubReviewId,
              body: $body,
              path: $path,
              line: $line,
              startLine: $startLine,
              side: $side,
              commitSha: $commitSha,
              inReplyToId: $inReplyToId,
              author: { login: $authorLogin, id: $authorId },
              createdAt: $createdAt
            }')

          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PRISM_API_KEY" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL/collect/review/comment/created"

      - name: Handle review comment edited event
        if: github.event.action == 'edited'
        run: |
          PAYLOAD=$(jq -n \
            --argjson githubCommentId "${{ github.event.comment.id }}" \
            --arg body "${{ github.event.comment.body }}" \
            --arg updatedAt "${{ github.event.comment.updated_at }}" \
            '{
              githubCommentId: $githubCommentId,
              body: $body,
              updatedAt: $updatedAt
            }')

          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PRISM_API_KEY" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL/collect/review/comment/edited"

      - name: Handle review comment deleted event
        if: github.event.action == 'deleted'
        run: |
          PAYLOAD=$(jq -n \
            --argjson githubCommentId "${{ github.event.comment.id }}" \
            --arg updatedAt "${{ github.event.comment.updated_at }}" \
            '{
              githubCommentId: $githubCommentId,
              updatedAt: $updatedAt
            }')

          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PRISM_API_KEY" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL/collect/review/comment/deleted"

  # ──────────────────────────────────────────────
  # 6. Slack: Review Request Notification
  # ──────────────────────────────────────────────
  collect-review-request-notification:
    if: github.event.action == 'review_requested'
    runs-on: ubuntu-latest
    env:
      WEBHOOK_URL: ${{ inputs.slack_webhook_url }}
    steps:
      - name: Setup PR-ism helpers
        uses: pr-ism/github-actions/.github/actions/prism-helpers@v1

      - name: Handle review requested event (Slack)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"

          PENDING_RAW=$(gh api "repos/$OWNER/$REPO/pulls/$PR_NUMBER/requested_reviewers" || echo '{"users":[],"teams":[]}')
          REVIEWED_RAW=$(gh api --paginate "repos/$OWNER/$REPO/pulls/$PR_NUMBER/reviews" || echo '[]')

          PENDING_USERS=$(echo "$PENDING_RAW" | jq -r --arg author "$AUTHOR" '[.users[].login? | select(. != $author)]')
          REVIEWED_USERS=$(echo "$REVIEWED_RAW" | jq -r --arg author "$AUTHOR" '[.[].user.login? | select(. != $author)] | sort | unique')

          PAYLOAD=$(jq -n \
            --arg repo "$REPO" \
            --arg prId "PR-$PR_NUMBER" \
            --argjson prNumber "$PR_NUMBER" \
            --arg prTitle "${{ github.event.pull_request.title }}" \
            --arg prUrl "${{ github.event.pull_request.html_url }}" \
            --arg author "$AUTHOR" \
            --argjson pending "$PENDING_USERS" \
            --argjson reviewed "$REVIEWED_USERS" \
            '{
              repositoryName: $repo,
              pullRequestId: $prId,
              pullRequestNumber: $prNumber,
              pullRequestTitle: $prTitle,
              pullRequestUrl: $prUrl,
              authorGithubId: $author,
              pendingReviewers: $pending,
              reviewedReviewers: $reviewed
            }')

          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $PRISM_API_KEY" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL/events/review-request"
